# 企微听录音统计报表系统

## 功能说明

这个Python项目用于自动处理听录音操作日志，生成统计报表（图片+文本）并发送到企业微信群。

### 主要功能

1. **自动检测新文件**: 监控file文件夹，自动识别当天下载的zip文件
2. **智能日期提取**: 优先从操作时间提取日期，失败则从文件名提取
3. **编码自动识别**: 支持多种中文编码格式（GBK、UTF-8、GB2312等）
4. **数据统计**: 按团队和个人统计听录音次数
5. **图片报表**: 生成包含美观表格的图片报表（需安装Pillow库）
6. **企微集成**: 自动发送图片报表到企业微信群
7. **网络优化**: 自动禁用系统代理，确保企业微信接口连接稳定
8. **定时任务**: 支持定时自动执行

## 文件结构

```
wecom bot/
├── main.py              # 主程序
├── report_generator.py  # 报表生成模块
├── run.bat              # Windows启动脚本
├── test_message.log     # 日志文件
├── file/                # 文件目录
│   ├── team_mapping.csv # 团队映射文件
│   └── *.zip            # 操作日志zip文件
└── README.md            # 说明文档
```

## 依赖包

```bash
pip install requests schedule chardet Pillow
```

## 使用方法

### 1. 准备团队映射文件

在`file/team_mapping.csv`中配置账号与团队的映射关系（注意文件编码）：

```csv
团队名称,账号
客服部,KF77100064
客服部,KF77100065
销售部,KF77100066
```

### 2. 放置日志文件

将当天下载的操作日志zip文件放入`file`文件夹中。
- 文件名示例：`操作日志查询_KF77100064_20251118155531338.zip`
- 程序会自动解压并读取其中的CSV文件

### 3. 运行程序

#### 方式一：使用批处理脚本（推荐）
双击运行 `run.bat`

#### 方式二：命令行运行
**立即执行模式**
```bash
python main.py
```

**定时运行模式**
```bash
python main.py --schedule
```
定时任务默认设置：
- 每天上午9:00执行
- 每小时检查一次新文件

## 配置说明

### 企业微信Webhook
在`main.py`中修改`webhook_url`变量。

### 报表生成
- 报表生成逻辑在 `report_generator.py` 中
- 如果安装了 `Pillow` 库，会自动生成图片报表
- 图片包含：汇总信息 + 详细排名表格

## 报表格式

生成的报表主要以图片形式发送到企业微信，包含：
- 📊 报表标题（含日期）
- 📈 汇总信息（总次数、参与人数、平均次数）
- 📋 详细数据表格（排名、团队、姓名、账号、次数）

## 日志记录

程序运行日志保存在 `test_message.log` 中，包含：
- 文件处理状态
- 编码检测结果
- 图片生成与上传状态
- 错误信息

## 故障排除

### 1. 中文编码问题
程序会自动检测文件编码。如果乱码，请检查CSV文件是否为标准的GBK或UTF-8编码。

### 2. 图片未生成
请检查是否安装了 `Pillow` 库 (`pip install Pillow`)。如果没有安装，程序将只生成文本摘要。

### 3. 企微发送失败
- 检查webhook URL是否正确
- 程序会自动尝试禁用代理以解决网络问题
- 查看 `test_message.log` 获取详细错误信息